name: Android Release APK (Hafif Sürüm)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Kodu Çek
        uses: actions/checkout@v3

      - name: Node.js Kurulumu
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'npm'

      - name: Java (JDK 17) Kurulumu
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Bağımlılıkları Yükle
        run: npm install

      - name: Expo CLI Yükle
        run: npm install -g expo-cli

      - name: Native Dosyaları Oluştur
        run: npx expo prebuild --platform android

      - name: Geçici İmza (Keystore) Oluştur
        # Release sürüm için zorunlu olan imza dosyasını oluşturur
        run: |
          keytool -genkeypair -v -keystore release.keystore -alias android -keyalg RSA -keysize 2048 -validity 10000 -storepass android -keypass android -dname "CN=AnimeTakvimi, OU=Android, O=Android, L=Android, S=Android, C=TR"

      - name: Release APK Derle
        # assembleDebug yerine assembleRelease kullanıyoruz
        run: cd android && ./gradlew assembleRelease

      - name: APK'yı İmzala
        # Oluşan imzasız APK'yı yukarıda yarattığımız anahtarla imzalıyoruz
        run: jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore release.keystore -storepass android -keypass android android/app/build/outputs/apk/release/app-release-unsigned.apk android

      - name: Dosya Adını Düzenle
        run: mv android/app/build/outputs/apk/release/app-release-unsigned.apk android/app/build/outputs/apk/release/AnimeTakvimi.apk

      - name: APK'yı Yükle
        uses: actions/upload-artifact@v4
        with:
          name: AnimeTakvimi-Release
          path: android/app/build/outputs/apk/release/AnimeTakvimi.apk
